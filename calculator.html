<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <!-- 引入AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1340.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@2.1.0/dist/amazon-cognito-identity.min.js"></script>
</head>
<body>
    <h1>Simple Calculator</h1>

    <!-- Login Form -->
    <div id="loginForm">
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="signIn()">Sign In</button>
        <button onclick="signUp()">Sign Up</button>
    </div>

    <!-- Calculator Form -->
    <div id="calculator" style="display: none;">
        <input type="number" id="num1" placeholder="Number 1">
        <input type="number" id="num2" placeholder="Number 2">
        <select id="operation">
            <option value="add">Add</option>
            <option value="subtract">Subtract</option>
            <option value="multiply">Multiply</option>
            <option value="divide">Divide</option>
        </select>
        <button onclick="calculate()">Calculate</button>
        <p id="result"></p>
    </div>

    <script>
        // 设置AWS区域
        AWS.config.region = 'us-east-1'; // Use your AWS region
        // 配置AWS凭证
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'us-east-1_eoAqsgQMT',
        });

        let cognitoUser = null;

        /**
         * 用户注册函数
         * @description 注册新用户并发送验证邮件
         */
        function signUp() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;
            var signUpDetails = {
                ClientId: '5jkql1b1crgpmn8dbcektrri22',
                Username: email,
                Password: password,
                UserAttributes: [
                    { Name: 'email', Value: email },
                ]
            };

            const cognitoidentityserviceprovider = new AWS.CognitoIdentityServiceProvider();
            cognitoidentityserviceprovider.signUp(signUpDetails, function(err, data) {
                if (err) {
                    alert(err.message || JSON.stringify(err));
                } else {
                    alert("Sign Up Successful! Please verify your email.");
                }
            });
        }

        /**
         * 用户登录函数
         * @description 用户登录并显示计算器界面
         */
        function signIn() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;

            var authenticationData = {
                Username: email,
                Password: password,
            };

            var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            var poolData = {
                UserPoolId: 'us-east-1_eoAqsgQMT',
                ClientId: '5jkql1b1crgpmn8dbcektrri22',
            };

            var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
            var userData = {
                Username: email,
                Pool: userPool,
            };

            cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: function(result) {
                    // 登录成功，获取凭证
                    AWS.config.credentials.refresh(function(err) {
                        if (err) {
                            alert('Error refreshing credentials: ' + err);
                        } else {
                            console.log("Credentials refreshed!");
                            alert("Login successful!");
                            document.getElementById("loginForm").style.display = "none";
                            document.getElementById("calculator").style.display = "block";
                        }
                    });
                },
                onFailure: function(err) {
                    alert(err.message || JSON.stringify(err));
                }
            });
        }

        /**
         * 计算函数
         * @description 根据用户选择的操作进行计算并显示结果
         */
        function calculate() {
            const num1 = parseFloat(document.getElementById("num1").value);
            const num2 = parseFloat(document.getElementById("num2").value);
            const operation = document.getElementById("operation").value;
            let result;

            if (operation === 'add') {
                result = num1 + num2;
            } else if (operation === 'subtract') {
                result = num1 - num2;
            } else if (operation === 'multiply') {
                result = num1 * num2;
            } else if (operation === 'divide') {
                result = num1 / num2;
            }

            document.getElementById("result").innerText = "Result: " + result;
            storeResult(num1, num2, operation, result);
        }

        /**
         * 存储结果函数
         * @description 将计算结果存储到DynamoDB
         */
        function storeResult(num1, num2, operation, result) {
            const lambda = new AWS.Lambda();

            const payload = {
                num1: num1,
                num2: num2,
                operation: operation,
                result: result,
                userId: cognitoUser.getUsername(),
            };

            const params = {
                FunctionName: 'calculator',  // Lambda function name
                Payload: JSON.stringify(payload),
            };

            lambda.invoke(params, function(err, data) {
                if (err) {
                    alert("Error saving to DynamoDB: " + err.message);
                } else {
                    alert("Calculation saved to DynamoDB.");
                }
            });
        }
    </script>
</body>
</html>
